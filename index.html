<!DOCTYPE html>
<html>
  <head>
    <title>Speech Synthesis API</title>
    <script>
      function speak() {
        const urlParams = new URLSearchParams(window.location.search);
        const text = urlParams.get('text');
        if (text) {
          const msg = new SpeechSynthesisUtterance();
          msg.text = text;
          const audioContext = new AudioContext();
          const audioDestination = audioContext.createMediaStreamDestination();
          msg.onend = () => {
            audioContext.close();
            const audioBlob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/save_audio', true);
            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.responseType = 'blob';
            xhr.onload = () => {
              console.log(xhr.response);
            };
            xhr.send(audioBlob);
          };
          const source = audioContext.createBufferSource();
          const gainNode = audioContext.createGain();
          source.buffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
          source.connect(gainNode);
          gainNode.connect(audioDestination);
          gainNode.gain.value = 0; // Mute the output to avoid feedback
          window.speechSynthesis.speak(msg);
          source.start();
        }
      }
    </script>
  </head>
  <body onload="speak()">
    <p>Speaking: <span id="text"></span></p>
  </body>
</html>
